# Event Flow Diagrams

## Simple Event Flow

```
User creates a sprint via Frontend
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Frontend  â”‚
    â”‚  (React)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ POST /sprints
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Sprint API      â”‚
    â”‚  (FastAPI)       â”‚
    â”‚                  â”‚
    â”‚  1. Validate     â”‚
    â”‚  2. Save to DB   â”‚
    â”‚  3. Publish      â”‚â—„â”€â”€â”€ You are here!
    â”‚     Events       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ 2 events published
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚    Kafka    â”‚
      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚
    â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚sprint.  â”‚    â”‚sprint.   â”‚
â”‚lifecycleâ”‚    â”‚team-     â”‚
â”‚         â”‚    â”‚members   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚
     â”‚              â”‚
     â–¼              â–¼
  Consumed by consumers
```

## Event Publishing Detail

```
POST /sprints
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ create_sprint() in sprints.py    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  â”‚
â”‚ 1. Validate request              â”‚
â”‚    if startDate >= endDate:      â”‚
â”‚      raise HTTPException(400)    â”‚
â”‚                                  â”‚
â”‚ 2. Create sprint in database     â”‚
â”‚    sprint = db.create_sprint()   â”‚
â”‚                                  â”‚
â”‚ 3. Update Prometheus metrics     â”‚
â”‚    sprints_created_total.inc()   â”‚
â”‚                                  â”‚
â”‚ 4. Publish to Kafka              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ await publish_sprint_  â”‚   â”‚
â”‚    â”‚ created_event(...)     â”‚   â”‚
â”‚    â”‚                        â”‚   â”‚
â”‚    â”‚ await publish_team_    â”‚   â”‚
â”‚    â”‚ member_added_event()   â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚
â”‚ 5. Return response               â”‚
â”‚    return sprint (201 Created)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Consumer Processing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kafka Topic: sprint.lifecycle â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Consumer Group A  â”‚
    â”‚  "email-service"   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ handle_sprint_created()  â”‚
    â”‚                          â”‚
    â”‚ 1. Parse event data      â”‚
    â”‚ 2. Fetch email template  â”‚
    â”‚ 3. Send email to team    â”‚
    â”‚ 4. Log success           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Consumer Group B  â”‚
    â”‚  "analytics"       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ handle_sprint_created()  â”‚
    â”‚                          â”‚
    â”‚ 1. Parse event data      â”‚
    â”‚ 2. Insert to analytics DBâ”‚
    â”‚ 3. Update dashboards     â”‚
    â”‚ 4. Calculate metrics     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Both consumers get the SAME event!
```

## Consumer Group Load Balancing

```
Topic: sprint.lifecycle (3 partitions)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Partitionâ”‚Partitionâ”‚Partitionâ”‚
â”‚    0    â”‚    1    â”‚    2    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚         â”‚         â”‚
     â”‚ Consumer Group: "sync-service"
     â”‚         â”‚         â”‚
     â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Instanceâ”‚Instanceâ”‚Instanceâ”‚
â”‚   1    â”‚   2    â”‚   3    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Each partition â†’ One instance
Events SPLIT across instances
```

## Multi-Topic Consumer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Email Notification   â”‚
â”‚ Service              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚
â”‚ Subscribes to:       â”‚
â”‚ â€¢ sprint.lifecycle   â”‚â—„â”€â”€â”€â”
â”‚ â€¢ sprint.team-       â”‚    â”‚
â”‚   members            â”‚â—„â”€â” â”‚
â”‚                      â”‚  â”‚ â”‚
â”‚ Handlers:            â”‚  â”‚ â”‚
â”‚ â€¢ sprint.created     â”‚  â”‚ â”‚
â”‚ â€¢ sprint.deleted     â”‚  â”‚ â”‚
â”‚ â€¢ team_member.added  â”‚  â”‚ â”‚
â”‚ â€¢ team_member.       â”‚  â”‚ â”‚
â”‚   updated            â”‚  â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
                          â”‚ â”‚
                    Topics in Kafka
```

## Event Schema Evolution

```
Version 1 (Now):
{
  "event_type": "sprint.created",
  "timestamp": "2025-11-27T10:30:00",
  "source": "sprint-capacity-api",
  "data": {
    "sprint_id": "123",
    "sprint_name": "Sprint 42"
  }
}

Version 2 (Future - Backward Compatible):
{
  "event_type": "sprint.created",
  "timestamp": "2025-11-27T10:30:00",
  "source": "sprint-capacity-api",
  "schema_version": "2.0",    â—„â”€â”€ New field
  "data": {
    "sprint_id": "123",
    "sprint_name": "Sprint 42",
    "tags": ["backend"]       â—„â”€â”€ New field
  }
}

Old consumers ignore new fields âœ…
New consumers handle both versions âœ…
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Consumer receives    â”‚
â”‚ event                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Try process  â”‚
    â”‚ event        â”‚
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚       â”‚
    Success  Error
       â”‚       â”‚
       â–¼       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Commit  â”‚ â”‚ Log error    â”‚
â”‚ offset  â”‚ â”‚ Don't commit â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ (retry later)â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
              After N retries
                   â”‚
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Send to DLQ  â”‚
            â”‚ (Dead Letter â”‚
            â”‚  Queue)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Production Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Internet   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Balancerâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
   â–¼       â–¼
â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”
â”‚API â”‚  â”‚API â”‚  (Multiple instances)
â”‚ 1  â”‚  â”‚ 2  â”‚
â””â”€â”€â”¬â”€â”˜  â””â”€â”€â”¬â”€â”˜
   â”‚       â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚ Publish events
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kafka Clusterâ”‚
â”‚              â”‚
â”‚ â”Œâ”€â”€â” â”Œâ”€â”€â”   â”‚
â”‚ â”‚B1â”‚ â”‚B2â”‚   â”‚  (Multiple brokers)
â”‚ â””â”€â”€â”˜ â””â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                    â”‚
   â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Consumer â”‚      â”‚Consumer  â”‚
â”‚Service 1â”‚      â”‚Service 2 â”‚
â”‚         â”‚      â”‚          â”‚
â”‚â”Œâ”€â”€â”€â”¬â”€â”€â”€â”â”‚      â”‚â”Œâ”€â”€â”€â”¬â”€â”€â”€â”â”‚
â”‚â”‚ 1 â”‚ 2 â”‚â”‚      â”‚â”‚ 1 â”‚ 2 â”‚â”‚  (Auto-scaling)
â”‚â””â”€â”€â”€â”´â”€â”€â”€â”˜â”‚      â”‚â””â”€â”€â”€â”´â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Testing Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Terminal 1: Kafka                   â”‚
â”‚ $ docker-compose up kafka zookeeper â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Terminal 2: Consumer                â”‚
â”‚ $ python examples/simple_consumer.pyâ”‚
â”‚                                     â”‚
â”‚ Output:                             â”‚
â”‚ ğŸ” Listening for events...          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Terminal 3: API                     â”‚
â”‚ $ uvicorn app.main:app --reload     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser: Create Sprint              â”‚
â”‚ POST http://localhost:8000/sprints  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Terminal 2 now shows:               â”‚
â”‚                                     â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚ ğŸ“¨ Event Received: sprint.created   â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚ Topic:     sprint.lifecycle         â”‚
â”‚ Sprint ID: sprint-abc123            â”‚
â”‚ Name:      Sprint 42                â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Event Timing

```
User Action             API Processing      Kafka        Consumer
    â”‚                        â”‚               â”‚              â”‚
    â”‚ POST /sprints          â”‚               â”‚              â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚              â”‚
    â”‚                        â”‚               â”‚              â”‚
    â”‚                        â”‚ Validate      â”‚              â”‚
    â”‚                        â”‚ Save to DB    â”‚              â”‚
    â”‚                        â”‚ (5-10ms)      â”‚              â”‚
    â”‚                        â”‚               â”‚              â”‚
    â”‚                        â”‚ Publish Event â”‚              â”‚
    â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚
    â”‚                        â”‚ (async)       â”‚              â”‚
    â”‚                        â”‚ (1-2ms)       â”‚              â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚              â”‚
    â”‚ 201 Created            â”‚               â”‚              â”‚
    â”‚ (Response returned)    â”‚               â”‚              â”‚
    â”‚                        â”‚               â”‚              â”‚
    â”‚                        â”‚               â”‚ Deliver      â”‚
    â”‚                        â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                        â”‚               â”‚ (near        â”‚
    â”‚                        â”‚               â”‚  instant)    â”‚
    â”‚                        â”‚               â”‚              â”‚
    â”‚                        â”‚               â”‚              â”‚ Process
    â”‚                        â”‚               â”‚              â”‚ (send email,
    â”‚                        â”‚               â”‚              â”‚  update DB,
    â”‚                        â”‚               â”‚              â”‚  etc.)
    â”‚                        â”‚               â”‚              â”‚
```

**Key Point**: API responds immediately, events processed asynchronously!
